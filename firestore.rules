rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Rule for the public recipes collection
    match /published_recipes/{recipeId} {
      // Anyone can read published recipes
      allow read: if true;
      // Only authenticated, verified users can create them
      allow create: if request.auth != null && request.auth.token.email_verified == true;
      // Only the author can update or delete their own recipe
      allow update, delete: if request.auth.uid == resource.data.publisherId;
    }

    // Rules for user-specific data
    match /users/{userId} {
      // Any authenticated user can get public profile data
      allow get: if request.auth != null;
      // A user can only create or update their own profile
      allow create, update, delete: if request.auth.uid == userId;

      // --- Rules for user sub-collections ---

      // Only the user can read/write their private recipes
      match /recipes/{recipeId} {
        allow read, write: if request.auth.uid == userId;
      }
      
      // Only the user can read/write their private menus
      match /menus/{menuId} {
        allow read, write: if request.auth.uid == userId;
      }
      
      // Rules for the social graph
      match /following/{targetUserId} {
        // Anyone can see who a user is following
        allow read: if request.auth != null;
        // A user can only change their own following list
        allow write: if request.auth.uid == userId;
      }
      
      match /followers/{followerId} {
        // Anyone can see a user's followers
        allow read: if request.auth != null;
        // A user can add/remove themselves as a follower
        allow write: if request.auth.uid == followerId;
      }
    }
  }
}
