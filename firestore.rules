
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Regla 1: Perfiles de Usuario (/users/{userId})
    // - Un usuario puede ver cualquier perfil público.
    // - Un usuario solo puede crear o editar su propio perfil.
    match /users/{userId} {
      allow get: if request.auth != null;
      allow create, update, delete: if request.auth.uid == userId;

      // Regla 2: Recetas y Menús Guardados (/users/{userId}/recipes/{recipeId}, /users/{userId}/menus/{menuId})
      // - Un usuario solo puede acceder a sus propias recetas y menús guardados.
      match /recipes/{recipeId} {
        allow read, write, delete: if request.auth.uid == userId;
      }

      match /menus/{menuId} {
        allow read, write, delete: if request.auth.uid == userId;
      }
      
      // Regla 3: Seguidores y Seguidos (/users/{userId}/followers/{followerId}, /users/{userId}/following/{followingId})
      // - Cualquiera puede ver quién sigue a quién (necesario para contadores y estado de "seguir").
      // - Un usuario solo puede modificar su propia lista de "seguidos".
      match /followers/{followerId} {
        allow get: if request.auth != null;
        allow create, delete: if request.auth.uid == followerId;
      }

      match /following/{followingId} {
        allow get: if request.auth != null;
        allow create, delete: if request.auth.uid == userId;
      }
    }

    // Regla 4: Recetas Públicas (/published_recipes/{recipeId})
    // - CUALQUIERA puede leer las recetas publicadas (ideal para la página de comunidad).
    // - Solo usuarios autenticados y verificados pueden publicar.
    // - Un usuario solo puede eliminar las recetas que él mismo publicó.
    match /published_recipes/{recipeId} {
      allow read: if true;
      allow create: if request.auth != null && request.auth.token.email_verified == true;
      allow update, delete: if request.auth != null && resource.data.publisherId == request.auth.uid;
    }
  }
}
