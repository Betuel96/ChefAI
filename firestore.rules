rules_version = '2';

// Estas son las reglas para Cloud Firestore
service cloud.firestore {
  match /databases/{database}/documents {

    // Reglas para la colección 'users'
    match /users/{userId} {
      
      // PERMISO DE LECTURA DE PERFILES:
      // Cualquier usuario autenticado puede LEER el perfil de otro usuario.
      // Esto es necesario para la página de perfil público y la comunidad.
      allow get: if request.auth != null;

      // PERMISO DE ESCRITURA DE PERFILES:
      // Un usuario solo puede crear, editar o borrar SU PROPIO perfil.
      allow write: if request.auth.uid == userId;

      // REGLAS PARA SUBCOLECCIONES PRIVADAS (Recetas y Menús guardados)
      // Un usuario solo puede acceder a sus propias recetas y menús.
      match /recipes/{recipeId} {
        allow read, write: if request.auth.uid == userId;
      }
      match /menus/{menuId} {
        allow read, write: if request.auth.uid == userId;
      }

      // REGLAS PARA SUBCOLECCIONES DE SEGUIMIENTO (followers/following)
      // Cualquiera puede VER quién sigue a quién, pero solo el usuario involucrado puede ESCRIBIR.
      match /followers/{followerId} {
        allow read: if request.auth != null;
        allow write: if request.auth.uid == followerId; // Solo el seguidor puede escribir/borrar
      }
      match /following/{followingId} {
        allow read: if request.auth != null;
        allow write: if request.auth.uid == userId; // Solo el usuario que sigue puede escribir/borrar
      }
    }

    // Reglas para la colección pública 'published_recipes'
    match /published_recipes/{recipeId} {
      
      // PERMISO DE LECTURA:
      // Cualquier usuario autenticado puede LEER todas las recetas publicadas.
      allow read: if request.auth != null;

      // PERMISO DE CREACIÓN:
      // Un usuario solo puede CREAR una publicación si el 'publisherId' es su propio UID.
      allow create: if request.auth.uid == request.resource.data.publisherId;

      // PERMISO DE EDICIÓN/BORRADO:
      // Un usuario solo puede EDITAR o BORRAR sus propias publicaciones.
      allow update, delete: if request.auth.uid == resource.data.publisherId;
    }
  }
}
