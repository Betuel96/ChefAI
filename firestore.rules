rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Regla de seguridad para la colección 'users'
    match /users/{userId} {
      // Permite a un usuario crear su propio perfil.
      allow create: if request.auth.uid == userId;
      // Permite a un usuario leer y actualizar su propio perfil.
      allow read, update: if request.auth.uid == userId;
      // Permite a cualquier usuario autenticado leer los perfiles de otros.
      allow get: if request.auth != null;
    }

    // Regla de seguridad para la colección 'usernames'
    match /usernames/{username} {
      // Permite a cualquier usuario autenticado leer los nombres de usuario.
      allow get: if request.auth != null;
      // Solo permite crear un nombre de usuario si no existe.
      allow create: if request.auth != null && !exists(path);
    }
    
    // Reglas para subcolecciones dentro de 'users'
    match /users/{userId}/{collectionId}/{docId} {
        // Permite al propietario del perfil leer y escribir en sus propias subcolecciones
        // (recetas, menús, posts guardados, etc.).
        allow read, write: if request.auth.uid == userId;
    }

    // Reglas de seguridad para las publicaciones
    match /published_recipes/{postId} {
        // Cualquiera puede leer posts públicos.
        allow get: if resource.data.profileType == 'public';
        // Solo el autor puede editarlo.
        allow update: if request.auth.uid == resource.data.publisherId;
        // Solo el autor puede eliminarlo.
        allow delete: if request.auth.uid == resource.data.publisherId;
        // Cualquier usuario autenticado puede crear un post.
        allow create: if request.auth != null;
    }

    // Reglas para subcolecciones de publicaciones (comentarios, me gusta)
    match /published_recipes/{postId}/{subcollection}/{docId} {
        // Cualquier usuario autenticado puede leer y escribir (comentar, dar 'me gusta').
        allow read, write: if request.auth != null;
    }

    // Reglas para la colección de administradores
    match /admins/{userId} {
      // Solo los usuarios autenticados pueden intentar leer. La existencia del
      // documento determina si son administradores o no.
      allow get: if request.auth != null;
    }
    
    // Reglas para las solicitudes de verificación
    match /verification_requests/{requestId} {
      // Solo el usuario que la creó puede leer su propia solicitud.
      allow get: if request.auth.uid == resource.data.userId;
      // Cualquier usuario autenticado puede crear una.
      allow create: if request.auth != null;
    }

    // Reglas para las historias
    match /stories/{storyId} {
      // Los usuarios autenticados pueden crear historias.
      allow create: if request.auth.uid == request.resource.data.publisherId;
      // Cualquier usuario autenticado puede leer historias (la lógica del feed filtra quién ve qué).
      allow read: if request.auth != null;
      // Solo el autor puede eliminar su historia.
      allow delete: if request.auth.uid == resource.data.publisherId;
    }
  }
}
