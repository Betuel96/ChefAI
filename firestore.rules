rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ===== Public Collections =====

    // Cualquiera puede leer las recetas publicadas.
    // Esto es crucial para que la página de la comunidad funcione para todos.
    match /published_recipes/{recipeId} {
      allow read: if true;

      // Solo usuarios autenticados y con correo verificado pueden crear recetas.
      allow create: if request.auth != null && request.auth.token.email_verified == true;

      // Solo el autor original puede actualizar o eliminar su propia receta.
      allow update, delete: if request.auth.uid == resource.data.publisherId;
    }


    // ===== User Data & Private Subcollections =====

    match /users/{userId} {
      // Cualquier usuario autenticado puede ver los datos públicos de un perfil.
      allow get: if request.auth != null;

      // Un usuario solo puede escribir en su propio documento.
      allow write: if request.auth.uid == userId;
      
      // --- Private Collections ---
      // Un usuario solo puede acceder a sus propias recetas y menús guardados.
      match /recipes/{recipeId} {
        allow read, write: if request.auth.uid == userId;
      }
      match /menus/{menuId} {
        allow read, write: if request.auth.uid == userId;
      }
      
      // --- Social Graph Collections ---
      // Cualquiera puede leer las listas de seguidores/seguidos para los contadores.
      // Un usuario solo puede modificar su propia lista de a quién sigue.
      match /following/{targetUserId} {
        allow read: if request.auth != null;
        allow write: if request.auth.uid == userId;
      }
      // Un usuario solo puede añadirse o quitarse a sí mismo de los seguidores de otro.
      match /followers/{followerId} {
        allow read: if request.auth != null;
        allow write: if request.auth.uid == followerId;
      }
    }
  }
}
