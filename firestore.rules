
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // User Profile Rules
    match /users/{userId} {
      // Anyone authenticated can view a user's public profile data.
      allow get: if request.auth != null;

      // A user can create their own profile, and update/delete it.
      allow create, update, delete: if request.auth != null && request.auth.uid == userId;
    }

    // Following/Followers Rules
    match /users/{userId}/following/{targetId} {
      // A user can only read and write to their own "following" list.
      allow read, write, delete: if request.auth != null && request.auth.uid == userId;
    }
    match /users/{userId}/followers/{followerId} {
      // A user can add/remove themselves from another user's "followers" list.
      allow create, delete: if request.auth != null && request.auth.uid == followerId;
      // Anyone can read the list of followers.
      allow get, list: if true;
    }

    // User's private recipe and menu collections
    match /users/{userId}/recipes/{recipeId} {
      // A user can only manage their own recipes.
      allow read, write, delete: if request.auth != null && request.auth.uid == userId;
    }
    match /users/{userId}/menus/{menuId} {
      // A user can only manage their own menus.
      allow read, write, delete: if request.auth != null && request.auth.uid == userId;
    }

    // Publicly Published Recipes
    match /published_recipes/{recipeId} {
      // Anyone can read published recipes.
      allow read: if true;

      // An authenticated user can publish a new recipe.
      allow create: if request.auth != null;

      // The original publisher can update or delete their recipe.
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.publisherId;
    }
  }
}
