rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // User Profiles
    // - Anyone authenticated can view a user's public profile data (get).
    // - Users can only create, update, or delete their own profile.
    // - Listing all users is disallowed for security.
    match /users/{userId} {
      allow get: if request.auth != null;
      allow list: if false; // Prevent querying the entire users collection
      allow create, update, delete: if request.auth.uid == userId;

      // Followers Subcollection
      // - Anyone authenticated can see who follows a user (list, get).
      // - A user can only add/remove themself as a follower of someone else.
      match /followers/{followerId} {
        allow read: if request.auth != null;
        allow write: if request.auth.uid == followerId;
      }

      // Following Subcollection
      // - A user can only see their own "following" list.
      // - A user can only modify their own "following" list.
      match /following/{followedId} {
        allow read, write: if request.auth.uid == userId;
      }

      // User's private data (recipes, menus)
      // This path matches /users/{userId}/recipes/{recipeId} and /users/{userId}/menus/{menuId}
      match /{privateCollection}/{docId} {
        allow read, write, delete: if request.auth.uid == userId;
      }
    }

    // Published Recipes
    // - Anyone authenticated can read (list, get).
    // - A user can only create a recipe for themself.
    // - A user can only update/delete their own published recipes.
    match /published_recipes/{recipeId} {
      allow read: if request.auth != null;
      allow create: if request.auth.uid == request.resource.data.publisherId;
      allow update, delete: if request.auth.uid == resource.data.publisherId;
    }
  }
}
